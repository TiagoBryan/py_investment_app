{% extends "global/base.html" %}
{% block header %}
{% include "global/partials/_header.html" %}
{% endblock header %}
{% block content %}
<div class="dashboard-container">
    <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 class="page-title" style="margin-bottom: 0.2rem; text-align: left;">PY Invest</h1>
            <p style="color: var(--text-light);">Área do Investidor</p>
        </div>
        
        <div style="display: flex; gap: 0.8rem;">
            {% if investidor %}
                <a href="{% url 'atualizar_perfil_investidor_page' %}" class="btn-settings" title="Configurações do Perfil">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Configurar
                </a>
            {% endif %}
            
            <a href="{% url 'home_page' %}" class="btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Voltar</a>
        </div>
    </div>

    {% if error %}
        <div class="alert alert-error">
            <strong>Indisponível:</strong> {{ error }}
        </div>
    {% else %}
        
        {% if investidor %}
            <div class="invest-hero-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h2>Patrimônio Total (Consolidado)</h2>
                        <div class="invest-balance">
                            R$ {{ patrimonio_total|floatformat:2 }}
                        </div>
                        <small style="opacity: 0.8;">
                            Conta: R$ {{ saldo_conta|floatformat:2 }} | Investido: R$ {{ total_investido|floatformat:2 }} | Declarado: R$ {{ investidor.patrimonio_total|floatformat:2 }}
                        </small>
                    </div>
                    
                    <div class="profile-badge">
                        {% if investidor.perfil_investidor == 'CONSERVADOR' %}Conservador
                        {% elif investidor.perfil_investidor == 'MODERADO' %}Moderado
                        {% else %}Arrojado{% endif %}
                    </div>
                </div>

                <div style="margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 1rem;">
                    <div class="projection-container">
                        <div class="projection-box">
                            <span class="projection-label">Taxa Anual (Renda Fixa)</span>
                            <div class="projection-value">
                                {% if investidor.perfil_investidor == 'CONSERVADOR' %}8%{% elif investidor.perfil_investidor == 'MODERADO' %}12%{% else %}18%{% endif %}
                            </div>
                        </div>
                        <div class="projection-box" style="background: rgba(255,255,255,0.2);">
                            <span class="projection-label">Em 12 meses (Estimado - Renda Fixa)</span>
                            <div class="projection-value">
                                R$ {{ projecao|floatformat:2 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Evolução Projetada (Juros Compostos - Renda Fixa)</h3>
                    <span class="chart-badge">Próximos 12 Meses</span>
                </div>
                <div id="projectionChart" style="min-height: 300px;"></div>
            </div>
            <h2 class="section-title">Gerenciar Carteira</h2>
            <div class="grid-cards">
                <a href="{% url 'realizar_investimento_page' %}" class="card-action">
                    <div class="card-icon" style="color: var(--invest-color); background: var(--invest-bg);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </div>
                    <div>
                        <h3 class="card-title">Novo Aporte</h3>
                        <p class="card-desc">Invista em Renda Fixa, Ações ou Cripto.</p>
                    </div>
                </a>

                <a href="{% url 'listar_investimentos_page' %}" class="card-action">
                    <div class="card-icon" style="color: var(--text-light);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    </div>
                    <div>
                        <h3 class="card-title">Carteira</h3>
                        <p class="card-desc">Detalhes e resgate de ativos.</p>
                    </div>
                </a>
            </div>

        {% else %}
            <div style="text-align: center; padding: 4rem 1rem; background: #fff; border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="color: var(--invest-color); margin-bottom: 1rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </div>
                <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Comece a investir hoje</h2>
                <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 2rem auto;">
                    Você ainda não possui um perfil de investidor. Cadastre-se agora para definir seu perfil e ver seu dinheiro render.
                </p>
                <a href="{% url 'criar_perfil_investidor_page' %}" class="btn btn-primary btn-lg" style="background-color: var(--invest-color); border: none;">
                    Criar Perfil de Investidor
                </a>
            </div>
        {% endif %}

    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rawPatrimonio = "{{ renda_fixa }}".replace(',', '.');
        let patrimonioAtual = parseFloat(rawPatrimonio);
        
        const perfil = "{{ investidor.perfil_investidor }}";
        
        let taxaAnual = 0.08;
        if (perfil === 'MODERADO') taxaAnual = 0.12;
        if (perfil === 'ARROJADO') taxaAnual = 0.18;

        const taxaMensal = Math.pow(1 + taxaAnual, 1/12) - 1;

        const meses = [];
        const valores = [];
        const hoje = new Date();
        const optionsDate = { month: 'short' };

        meses.push('Hoje');
        valores.push(patrimonioAtual.toFixed(2));

        for (let i = 1; i <= 12; i++) {
            patrimonioAtual = patrimonioAtual * (1 + taxaMensal);
            
            valores.push(patrimonioAtual.toFixed(2));
            
            let mesFuturo = new Date();
            mesFuturo.setMonth(hoje.getMonth() + i);
            meses.push(mesFuturo.toLocaleDateString('pt-BR', optionsDate));
        }

        var options = {
            series: [{
                name: 'Patrimônio Projetado',
                data: valores
            }],
            chart: {
                height: 350,
                type: 'area',
                toolbar: { show: false },
                fontFamily: 'Inter, sans-serif'
            },
            colors: ['#7c3aed'],
            dataLabels: { enabled: false },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.2,
                    stops: [0, 90, 100]
                }
            },
            xaxis: {
                categories: meses,
                tooltip: { enabled: false },
                axisBorder: { show: false },
                axisTicks: { show: false }
            },
            yaxis: {
                labels: {
                    formatter: function (value) {
                        return "R$ " + value.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return "R$ " + parseFloat(val).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            },
            grid: {
                borderColor: '#f1f1f1',
                padding: { top: 10, bottom: 10 }
            }
        };

        if (document.querySelector("#projectionChart")) {
            var chart = new ApexCharts(document.querySelector("#projectionChart"), options);
            chart.render();
        }
    });
</script>
{% endblock content %}